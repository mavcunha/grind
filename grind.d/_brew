# vim: ft=zsh
SUBCOMMAND_DESC="Library for homebrew definitions"
SUBCOMMAND_HELP=$(cat <<EOH
Functions:

brew_pkg PKG      brew_pkg "package_name"
                  will install package_name unless
                  it is already installed.

brew_cask CASK    brew_cask "cask_name"
                  will install cask_name unless
                  it is already installed.

EOH
)

# we should keep the list of installed packages
# throughout the run to avoid executing 
# 'brew list' over and over again
typeset -g _BREW_PKG_INSTALLED
typeset -g _BREW_CASK_INSTALLED
typeset -g _BREW_TAP_INSTALLED

function _brew_pkg_installed() {
  _BREW_PKG_INSTALLED="${_BREW_PKG_INSTALLED:-$(brew list)}"
  log "brew_packages_list: ${_BREW_PKG_INSTALLED}"
  grep -qE "^${1}$" <(echo "${_BREW_PKG_INSTALLED}")
}

function _brew_cask_installed() {
  _BREW_CASK_INSTALLED="${_BREW_CASK_INSTALLED:-$(brew list --cask)}"
  log "brew_casks_list: ${_BREW_CASK_INSTALLED}"
  grep -qE "^${1}$" <(echo "${_BREW_CASK_INSTALLED}")
}

function _brew_tap_installed() {
  _BREW_TAP_INSTALLED="${_BREW_TAP_INSTALLED:-$(brew tap)}"
  log "brew_tap_list: ${_BREW_TAP_INSTALLED}"
  grep -qE "^${1}$" <(echo "${_BREW_TAP_INSTALLED}")
}

function brew_pkg() {
  local formula="${1}"
  local short=${formula##*/}
  log "brew_pkg: ${formula} shortname: ${short}"
  do_run "brew install ${formula}"
    unless "_brew_pkg_installed '${short}'"
}

function brew_cask() {
  local cask="${1}"
  local short=${cask##*/}
  log "brew_cask: ${cask} shortname: ${short}"
  do_run "brew install --cask ${cask}"
    unless "_brew_cask_installed '${short}'"
}

function brew_tap() {
  local tap="${1}"
  log "brew_tap: ${tap}"
  do_run "brew tap ${tap}"
    unless "_brew_tap_installed '${tap}'"
}
